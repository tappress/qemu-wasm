<!DOCTYPE html>
<html>
<head>
    <title>SABFS Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #eee; }
        .pass { color: #0f0; }
        .fail { color: #f00; }
        .info { color: #0af; }
        pre { background: #2a2a3e; padding: 10px; border-radius: 5px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #output { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>SABFS Test Suite</h1>
    <div>
        <button onclick="runTests()">Run Tests</button>
        <button onclick="runBenchmark()">Run Benchmark</button>
        <button onclick="clearOutput()">Clear</button>
    </div>
    <pre id="output"></pre>

    <script src="sabfs.js"></script>
    <script src="sabfs-loader.js"></script>
    <script>
        const output = document.getElementById('output');

        function log(msg, className = '') {
            const span = document.createElement('span');
            span.className = className;
            span.textContent = msg + '\n';
            output.appendChild(span);
        }

        function clearOutput() {
            output.innerHTML = '';
        }

        function assert(condition, msg) {
            if (condition) {
                log(`✓ ${msg}`, 'pass');
                return true;
            } else {
                log(`✗ ${msg}`, 'fail');
                return false;
            }
        }

        async function runTests() {
            clearOutput();
            log('=== SABFS Test Suite ===', 'info');
            log('');

            let passed = 0;
            let failed = 0;

            // Test 1: Initialize
            log('Test 1: Initialization', 'info');
            try {
                const sab = await SABFSLoader.init({ size: 64 * 1024 * 1024 }); // 64MB
                if (assert(sab instanceof SharedArrayBuffer, 'Returns SharedArrayBuffer')) passed++; else failed++;
                if (assert(sab.byteLength === 64 * 1024 * 1024, 'Correct size')) passed++; else failed++;
            } catch (e) {
                log(`Error: ${e.message}`, 'fail');
                failed++;
            }
            log('');

            // Test 2: Stat root
            log('Test 2: Root directory', 'info');
            const rootStat = SABFS.stat('/');
            if (assert(rootStat !== null, 'Root exists')) passed++; else failed++;
            if (assert(rootStat && rootStat.isDirectory, 'Root is directory')) passed++; else failed++;
            log('');

            // Test 3: Stat /docker
            log('Test 3: Docker directory created', 'info');
            const dockerStat = SABFS.stat('/docker');
            if (assert(dockerStat !== null, '/docker exists')) passed++; else failed++;
            if (assert(dockerStat && dockerStat.isDirectory, '/docker is directory')) passed++; else failed++;
            log('');

            // Test 4: Create file
            log('Test 4: Create and read file', 'info');
            const testData = 'Hello, SABFS!\n';
            if (assert(SABFSLoader.importFile('/docker/test.txt', testData), 'File created')) passed++; else failed++;

            const testStat = SABFS.stat('/docker/test.txt');
            if (assert(testStat !== null, 'File stat works')) passed++; else failed++;
            if (assert(testStat && testStat.size === testData.length, `File size correct (${testStat?.size})`)) passed++; else failed++;
            log('');

            // Test 5: Read file content
            log('Test 5: Read file content', 'info');
            const exported = SABFS.exportFile('/docker/test.txt');
            if (assert(exported !== null, 'File exported')) passed++; else failed++;
            const content = new TextDecoder().decode(exported);
            if (assert(content === testData, `Content matches: "${content.trim()}"`)) passed++; else failed++;
            log('');

            // Test 6: File descriptor operations
            log('Test 6: File descriptor operations', 'info');
            const fd = SABFS.open('/docker/test.txt', SABFS.O_RDONLY);
            if (assert(fd >= 0, `Open returned fd=${fd}`)) passed++; else failed++;

            const readBuf = new Uint8Array(100);
            const bytesRead = SABFS.read(fd, readBuf, 100);
            if (assert(bytesRead === testData.length, `Read ${bytesRead} bytes`)) passed++; else failed++;

            const closeResult = SABFS.close(fd);
            if (assert(closeResult === 0, 'Close succeeded')) passed++; else failed++;
            log('');

            // Test 7: Large file
            log('Test 7: Large file (1MB)', 'info');
            const largeData = new Uint8Array(1024 * 1024);
            for (let i = 0; i < largeData.length; i++) {
                largeData[i] = i & 0xFF;
            }

            const fd2 = SABFS.open('/docker/large.bin', SABFS.O_CREAT | SABFS.O_RDWR, 0o644);
            if (assert(fd2 >= 0, `Created large file fd=${fd2}`)) passed++; else failed++;

            const written = SABFS.write(fd2, largeData, largeData.length);
            if (assert(written === largeData.length, `Wrote ${written} bytes`)) passed++; else failed++;

            SABFS.lseek(fd2, 0, SABFS.SEEK_SET);
            const readBack = new Uint8Array(1024 * 1024);
            const readLarge = SABFS.read(fd2, readBack, readBack.length);
            if (assert(readLarge === largeData.length, `Read back ${readLarge} bytes`)) passed++; else failed++;

            let match = true;
            for (let i = 0; i < largeData.length; i++) {
                if (largeData[i] !== readBack[i]) {
                    match = false;
                    break;
                }
            }
            if (assert(match, 'Data integrity verified')) passed++; else failed++;

            SABFS.close(fd2);
            log('');

            // Test 8: Directory listing
            log('Test 8: Directory listing', 'info');
            const entries = SABFS.readdir('/docker');
            if (assert(entries !== null, 'Readdir works')) passed++; else failed++;
            if (assert(Array.isArray(entries), 'Returns array')) passed++; else failed++;
            log(`  Entries: ${entries?.map(e => e.name).join(', ')}`);
            log('');

            // Summary
            log('=== Summary ===', 'info');
            log(`Passed: ${passed}`, passed > 0 ? 'pass' : '');
            log(`Failed: ${failed}`, failed > 0 ? 'fail' : 'pass');
        }

        async function runBenchmark() {
            clearOutput();
            log('=== SABFS Benchmark ===', 'info');
            log('');

            // Ensure initialized
            if (!SABFSLoader.isInitialized()) {
                await SABFSLoader.init({ size: 128 * 1024 * 1024 });
            }

            // Benchmark 1: Small file reads
            log('Benchmark 1: Small file reads (1000 iterations)', 'info');
            SABFSLoader.importFile('/docker/bench/small.txt', 'x'.repeat(100));

            const fd = SABFS.open('/docker/bench/small.txt', SABFS.O_RDONLY);
            const buf = new Uint8Array(100);

            const start1 = performance.now();
            for (let i = 0; i < 1000; i++) {
                SABFS.lseek(fd, 0, SABFS.SEEK_SET);
                SABFS.read(fd, buf, 100);
            }
            const elapsed1 = performance.now() - start1;
            log(`  Time: ${elapsed1.toFixed(2)}ms`);
            log(`  Per read: ${(elapsed1 / 1000).toFixed(4)}ms`);
            log(`  Reads/sec: ${(1000 / elapsed1 * 1000).toFixed(0)}`);
            SABFS.close(fd);
            log('');

            // Benchmark 2: Large file read
            log('Benchmark 2: Large file read (10MB)', 'info');
            const largeData = new Uint8Array(10 * 1024 * 1024);
            SABFSLoader.importFile('/docker/bench/large.bin', largeData);

            const fd2 = SABFS.open('/docker/bench/large.bin', SABFS.O_RDONLY);
            const largeBuf = new Uint8Array(10 * 1024 * 1024);

            const start2 = performance.now();
            const bytesRead = SABFS.read(fd2, largeBuf, largeBuf.length);
            const elapsed2 = performance.now() - start2;
            log(`  Time: ${elapsed2.toFixed(2)}ms`);
            log(`  Throughput: ${(bytesRead / 1024 / 1024 / (elapsed2 / 1000)).toFixed(2)} MB/s`);
            SABFS.close(fd2);
            log('');

            // Benchmark 3: Write performance
            log('Benchmark 3: Write performance (10MB)', 'info');
            const fd3 = SABFS.open('/docker/bench/write.bin', SABFS.O_CREAT | SABFS.O_RDWR, 0o644);

            const start3 = performance.now();
            const written = SABFS.write(fd3, largeData, largeData.length);
            const elapsed3 = performance.now() - start3;
            log(`  Time: ${elapsed3.toFixed(2)}ms`);
            log(`  Throughput: ${(written / 1024 / 1024 / (elapsed3 / 1000)).toFixed(2)} MB/s`);
            SABFS.close(fd3);
            log('');

            // Benchmark 4: pread random access
            log('Benchmark 4: Random pread (1000 x 4KB)', 'info');
            const fd4 = SABFS.open('/docker/bench/large.bin', SABFS.O_RDONLY);
            const chunk = new Uint8Array(4096);
            const maxOffset = 10 * 1024 * 1024 - 4096;

            const start4 = performance.now();
            for (let i = 0; i < 1000; i++) {
                const offset = Math.floor(Math.random() * maxOffset);
                SABFS.pread(fd4, chunk, 4096, offset);
            }
            const elapsed4 = performance.now() - start4;
            log(`  Time: ${elapsed4.toFixed(2)}ms`);
            log(`  Per pread: ${(elapsed4 / 1000).toFixed(4)}ms`);
            log(`  IOPS: ${(1000 / elapsed4 * 1000).toFixed(0)}`);
            SABFS.close(fd4);
            log('');

            log('=== Benchmark Complete ===', 'info');
        }
    </script>
</body>
</html>
